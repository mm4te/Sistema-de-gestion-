<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Registrar Venta</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <style>
    .carrito-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      margin: 8px 0;
      background: #f8f9fa;
    }

    .carrito-item-info {
      flex: 1;
    }

    .carrito-item-actions {
      display: flex;
      gap: 8px;
      margin-left: 15px;
    }

    .btn-small {
      padding: 6px 10px;
      font-size: 0.9rem;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .btn-edit {
      background: #4361ee;
      color: white;
    }

    .btn-delete {
      background: #e63946;
      color: white;
    }
  </style>
</head>

<body>
  <div class="layout">
    <!-- Sidebar izquierdo -->
    <div class="sidebar">
      <h2><span> Comenda Deco</span></h2>
      <a href="/"><span>ğŸ“Š Inicio</span></a>
      <a href="/inventario" ><span>ğŸ“¦ Inventario</span></a>
      <a href="/ventas"class="active"><span>ğŸ›’ Ventas</span></a>
      <a href="/clientes"><span>ğŸ‘¥ Clientes</span></a>
      <a href="/ventas_historial"><span>ğŸ“ˆ Ventas Hist.</span></a>
       
      <a href="/reporte/excel"><span>ğŸ“¥ Reporte</span></a>
      <a href="/logout" style="margin-top: auto; color: #e63946;"><span>ğŸšª Cerrar sesiÃ³n</span></a>
    </div>

    <div class="main-content">
      <main>
        <a href="/" class="back-link">â† Volver al inicio</a>

        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        <div class="flash-messages">
          {% for category, message in messages %}
          <p class="{{ category }}">{{ message }}</p>
          {% endfor %}
        </div>
        {% endif %}
        {% endwith %}

        <!-- DiseÃ±o de dos columnas -->
        <div style="display: flex; gap: 30px; flex-wrap: wrap;">
          <!-- Columna izquierda: Cliente y productos -->
          <div style="flex: 1; min-width: 300px;">
            <!-- SelecciÃ³n de cliente -->
            <form method="post" action="/guardar_cliente" style="margin-bottom: 20px;">
              <label for="cliente">Cliente:</label>
              <select name="cliente_id" id="cliente" required onchange="this.form.submit()">
                <option value="">-- Selecciona un cliente --</option>
                {% for id, nombre in clientes %}
                <option value="{{ id }}" {% if id==cliente_id_seleccionado %}selected{% endif %}>{{ nombre }}</option>
                {% endfor %}
              </select>
            </form>

            <!-- BÃºsqueda de productos -->
            <div style="margin: 20px 0;">
              <label for="search-productos" style="display: block; margin-bottom: 8px; font-weight: 600;">ğŸ” Buscar
                producto:</label>
              <input type="text" id="search-productos" placeholder="CÃ³digo o descripciÃ³n..."
                style="width: 100%; padding: 12px; border: 1px solid #dee2e6; border-radius: 8px; font-size: 1rem;">
            </div>

            <!-- Lista de productos -->
            <h3>Productos disponibles ({{ productos|length }})</h3>
            <div id="productos-lista">
              {% for p in productos %}
              <div class="product-card" data-codigo="{{ p[1] }}" data-descripcion="{{ p[2] }}">
                <strong>{{ p[1] }} - {{ p[2] }}</strong>
                <small>Precio: ${{ "%.2f"|format(p[3]) }} | Stock: {{ p[4] }}</small>
                <form method="post" action="/agregar_al_carrito"
                  style="margin-top: 10px; display: flex; align-items: center; gap: 8px;">
                  <input type="hidden" name="producto_id" value="{{ p[0] }}">
                  <input type="number" name="cantidad" min="1" max="{{ p[4] }}" value="1"
                    style="width: 80px; padding: 6px; border: 1px solid #dee2e6; border-radius: 4px;" required>
                  <button type="submit"
                    style="padding: 6px 12px; background: #4361ee; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9rem;">â•
                    Agregar</button>
                </form>
              </div>
              {% endfor %}
            </div>
          </div>

          <!-- Columna derecha: Carrito -->
          <div style="flex: 1; min-width: 300px;">
            <h3>ğŸ›’ Carrito ({{ carrito|length }} productos)</h3>

            {% if carrito %}
            <div
              style="max-height: 400px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 8px; padding: 10px;">
              {% for item in carrito %}
              <div class="carrito-item">
                <div class="carrito-item-info">
                  <strong>{{ item.descripcion }} ({{ item.codigo }})</strong><br>
                  ${{ "%.2f"|format(item.precio) }} x {{ item.cantidad }} = ${{ "%.2f"|format(item.subtotal) }}
                </div>
                <div class="carrito-item-actions">
                  <form method="post" action="/actualizar_carrito" style="display: inline;">
                    <input type="hidden" name="index" value="{{ loop.index0 }}">
                    <input type="number" name="cantidad" value="{{ item.cantidad }}" min="1"
                      style="width: 60px; padding: 4px;" required>
                    <button type="submit" class="btn-small btn-edit">âœï¸</button>
                  </form>
                  <a href="/eliminar_del_carrito/{{ loop.index0 }}" class="btn-small btn-delete"
                    onclick="return confirm('Â¿Eliminar del carrito?')">ğŸ—‘ï¸</a>
                </div>
              </div>
              {% endfor %}
            </div>

            <div style="margin-top: 15px; font-size: 1.4rem; font-weight: bold;">
              Total: ${{ "%.2f"|format(total) }}
            </div>

            <!-- BotÃ³n de selecciÃ³n de pago -->
            {% if cliente_id_seleccionado and carrito %}
            <a href="/seleccionar_pago"
              style="display: block; margin-top: 15px; background: #2ecc71; color: white; padding: 12px 25px; 
                        font-size: 1.1rem; text-decoration: none; border-radius: 8px; text-align: center; font-weight: bold;">
              ğŸ’³ Seleccionar MÃ©todo de Pago
            </a>
            {% elif cliente_id_seleccionado %}
            <p style="color: #e63946; margin-top: 15px;">âš ï¸ Agrega productos al carrito para continuar.</p>
            {% else %}
            <p style="color: #e63946; margin-top: 15px;">âš ï¸ Selecciona un cliente para continuar.</p>
            {% endif %}

            <a href="/vaciar_carrito"
              style="display: block; margin-top: 10px; color: #6c757d; text-decoration: none; text-align: center;">
              ğŸ—‘ï¸ Vaciar carrito
            </a>

            {% else %}
            <p>El carrito estÃ¡ vacÃ­o.</p>
            {% endif %}
          </div>
        </div>
      </main>
    </div>

    <script>
      // BÃºsqueda en productos
      document.getElementById('search-productos').addEventListener('input', function () {
        const query = this.value.toLowerCase().trim();
        document.querySelectorAll('.product-card').forEach(card => {
          const codigo = card.dataset.codigo.toLowerCase();
          const descripcion = card.dataset.descripcion.toLowerCase();
          card.style.display = (codigo.includes(query) || descripcion.includes(query)) ? 'block' : 'none';
        });
      });
    </script>
</body>

</html>
